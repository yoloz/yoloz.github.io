---
title: 服务自启动
comments: false
toc: false
date: 2020-02-29 16:39:56
categories: linux
tags:
---

## centos

可有如下三种方式

### ln -s 建立软连接

在CentOS中总共有7种运行级别，可以在/etc/inittab 文件中进行设置，7种运行级别对应着 /etc/rc.d/rc[0-6].d 这7个目录,也就是说在每一个目录下的内容表示在该运行级别下应该启动或者关闭的服务。
其实，这些服务都是/etc/init.d/中某个服务的软连接，所以真正启动的服务是/etc/init.d目录中的某一个服务。

> 你可能也发现了在/etc下也有同样的7个文件夹即 /etc/rc[0-6].d ，通过查看发现/etc/rc[0-6].d其实就是/etc/rc.d/rc[0-6].d的软连接，只是为了保持和Unix的兼容性

如果我们自己写了一个脚本代码如cleanupd，需要在开机级别为3的时候自启动的话，那么我们只需要把可执行的cleanupd脚本文件放到 /etc/init.d目录下，并在对应的运行级别目录下 如/etc/rc.d/rc3.d/ 建立一个以S开头后加数字的软连接到/etc/init.d/cleanupd即可，如`ln -s /etc/init.d/cleanupd /etc/rc.d/rc3.d/S95cleanup`

### chkconfig

鉴于上面的手工操作比较繁琐，在CentOS中专门提供了chkconfig 命令来设置或者取消开机自启动服务。

``` sh
chkconfig --list                 #当前系统已经设置的各个服务在各个运行级别下的开闭状态
chkconfig --list  sshd           #查看具体服务
chkconfig servicename on/off     #启动关闭
```

> 如果这个服务尚未被添加到 chkconfig 列表中，则现需要使用 –-add 参数将其添加进去`chkconfig --add sshd`

###  /etc/rc.d/rc.local 

``` sh
$ vim /etc/rc.d/rc.local
#/usr/sbin/apachectlstart
#/etc/rc.d/init.d/mysqldstart
#/etc/rc.d/init.d/smbstart
#/usr/local/subversion/bin/svnserve-d
```

## ubuntu

一般直接编辑 */etc/rc.d/rc.local*添加自启动脚本即可，18.04则不行(ubuntu 18.04 不再使用 inited 管理系统，改用 systemd)

> systemd 默认读取 /etc/systemd/system 下的文件，该目录下的文件会链接/lib/systemd/system/下的文件

执行`ls /lib/systemd/system` 你可以看到有很多启动脚本，其中就有我们需要的 *rc.local.service*

``` txt
[Unit]
Description=/etc/rc.local Compatibility
Documentation=man:systemd-rc-local-generator(8)
ConditionFileIsExecutable=/etc/rc.local
After=network.target

[Service]
Type=forking
ExecStart=/etc/rc.local start
TimeoutSec=0
RemainAfterExit=yes
GuessMainPID=no
```

一般正常的启动文件主要分成三部分
* Unit段: 启动顺序与依赖关系 
* Service段: 启动行为,如何启动，启动类型 
* Install段: 定义如何安装这个配置文件，即怎样做到开机启动

可以看出，/etc/rc.local 的启动顺序是在网络后面，但是显然它少了 Install 段，也就没有定义如何做到开机启动，所以显然这样配置是无效的。 因此我们就需要在后面帮他加上 Install段:

``` txt
[Install]  
WantedBy=multi-user.target  
Alias=rc-local.service
```

这里需要注意一下，ubuntu-18.04默认是没有 /etc/rc.local 这个文件的，需要自己创建`sudo vim /etc/rc.local`把需要自启动的服务添加进去。

> 设置权限`chmod 755 /etc/rc.local`

systemd 默认读取 /etc/systemd/system 下的配置文件, 所以还需要在 /etc/systemd/system 目录下创建软链接
`ln -s /lib/systemd/system/rc.local.service /etc/systemd/system/`,然后重启系统

